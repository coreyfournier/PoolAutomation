<!DOCTYPE html >
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    
   <head>
      <title>Pool Controls</title>
      <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/site.css">
   </head>
    <script src="/js/jquery-3.6.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
	
   <body>
    <div class="container">
        <div class="row">
            <div class="col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Schedules</h3>
                    </div>
                    <div class="panel-body">
                        <div id="schedule"></div>
                    </div>
                </div>
            </div>
    </div>    
    <div class="row">
        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">GloBrite Color Changer</h3>
                </div>
                <div class="panel-body">
                    <p>Choose A Scene</p>
                    <select name="scene" id="scene" style="width: 250px;"><option value="-1">-</option>></select>
                    <button onclick="sceneChange()">Change</button>
                    <br>
                    <br>
                    <button onclick="lightOff()">Off</button>
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pump</h3>
                </div>
                <div class="panel-body">
                    <select name="speed" id="speed" style="width: 250px;" onchange="speedChange(this)"></select>
                </div>
            </div>
        </div>
    </div>

    <table class="table">
        <tr>            
            <td valign="top">                                
            </td>
        </tr>
    </table>

    
      <div id="footer">
         <hr>
      </div>
    </div>		
   </body>
	<script>
        $(document).ready(function(){

            $.getJSON("/light/descriptions", function(result) {
                var options = $("#scene");
                //don't forget error handling!
                $.each(result, function(index) {
                    options.append($("<option />").val(index).text(this[1] + ' - ' + this[2]));
                });
            });

            $.getJSON("/pump/descriptions", function(result) {
                var options = $("#speed");
                //don't forget error handling!
                $.each(result, function(pumpIndex, pump) {
                    console.log("pump=" + pump.description)
                    $.each(pump.speeds, function(speedIndex, speed){
                        options.append($("<option id='pump_" + pump.index + "_" + speed.name + "' "+ (speed.isActive? "selected":"") +" />").text(speed.name));
                    });
                });
            });

            $.getJSON("/schedule/schedules", function(result) {
                var options = $("#schedule");
                //don't forget error handling!
                $.each(result, function(scheduleIndex, schedule) {
                    var container = $("<div id='schedule-" + schedule.id + "'>")
                    container.append("<div>"+schedule.name + (schedule.isRunning? " - running" : "") + "</div>")
                    container.append("<div>"+schedule.startTime + " to " + schedule.startTime + "</div>")
                    
                    $.each(schedule.pumps, function(pumpIndex, pump){
                        container.append($("<div id='schdule-"+schedule.id+"-pump-" + pump.id + "'>pump: " + pump.name+"</div>"));
                    });

                    $.each(schedule.valves, function(valveIndex, valve){
                        container.append($("<div id='schdule-"+schedule.id+"-valve-" + valve.id + "'>valve: "+valve.name+"</div>"));
                    });
                    container.appendTo(options);                    
                });
            });
        });
        
        function speedChange(control)
        {
            console.log($(control).val());
            $.ajax({
                    url: '/pump/on?pumpIndex=0&speed=' + $(control).val(),
                    success: function(){
                        alert('changed speed to ' + $(control).val());
                    }
            });
        }

        function sceneChange(){
            var selectedValue = $('#scene option').filter(":selected").val();

            if(selectedValue >= 0)
            {
                $.ajax({
                    url: '/light/change?sceneIndex=' + selectedValue,
                    success: function(){
                        alert('changed scene');
                    }
                    });
            }
        }

        function lightOff(){
            $.ajax({
                url: '/off',
                success: function(){
                    alert('turned off');
                }
                });
        }
    </script>
</html>