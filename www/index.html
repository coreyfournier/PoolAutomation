<!DOCTYPE html >
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    
   <head>
      <title>Pool Controls</title>
      <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/site.css">
    <link rel="stylesheet" href="/css/bootstrap-toggle.min.css">
    
   </head>
    <script src="/js/jquery-3.6.3.min.js"></script>
    <script src="/js/jquery-dateformat.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap-toggle.min.js"></script>
    
	
   <body>
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Schedules</h3>
                    </div>
                    <div class="panel-body">
                        <div id="schedule"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-2" id="temperature"></div>

            <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">GloBrite Color Changer</h3>
                </div>
                <div class="panel-body">
                    <p>Choose A Scene</p>
                    <select name="scene" id="scene" style="width: 250px;"><option value="-1">-</option>></select>
                    <button onclick="sceneChange()">Change</button>
                    <br>
                    <br>
                    <button onclick="lightOff()">Off</button>
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pump</h3>
                </div>
                <div class="panel-body" id="pumps">
                    
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Slide</h3>
                </div>
                <div class="panel-body">
                    <input type="checkbox" id="slide-toggle" data-style="slow">
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title status-off" id="solar-heat-on">Solar Heater</h3>
                </div>
                <div class="panel-body">
                    <input type="number" min="80" step=".5" max="92" class="form-control" id="heat-temperature">
                    <input type="checkbox" id="heat-enabled-toggle" data-style="slow">
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title status-on" id="freeze-prevention-on">Freeze prevention</h3>
                </div>
                <div class="panel-body">
                    <input type="checkbox" id="freeze-prevention-enabled" data-style="slow">
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Valves</h3>
                </div>
                <div class="panel-body" id="valves"></div>
            </div>
        </div>
    </div>
    
      <div id="footer">
         <hr>
      </div>
    </div>		
   </body>
	<script>
        var heaterVariable = "solar-heat-temperature";
        var slideVariable = "slide-enabled";
        var heaterEnabledVariable = "solar-heat-enabled";

        $(document).ready(loadUiData);

        function changeVariable(timeoutId, variable, lastValue, onSuccess)
        {
            //Adding a delay so it doesn't over load the server if you are togging through the values.
            if(timeoutId != null)                    
                clearTimeout(timeoutId);            

            timeoutId = setTimeout(function(){
                console.log("Changing " + lastValue);
                if(timeoutId != null)                    
                    clearTimeout(timeoutId);

                $.ajax({
                    type:"POST",
                    dataType:"json",
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify({
                        "name" : variable,
                        "value": lastValue
                    }),
                    url: '/variable/change',
                    success: function(result){
                        console.log('Variable changed ' + JSON.stringify(result));
                        if(onSuccess != null)
                            onSuccess(result);
                    }
                });
                
            }, 5000);                    
            
            return timeoutId;
        }

        function setToggleFromVariable(variableName, toggleControl, onChange)
        {
            $.getJSON("/variable/get?name=" + variableName, function(result) {
                var lastValue = false;
                var timeoutId = null;

                if(result.value)
                    toggleControl.bootstrapToggle('on');
                else
                    toggleControl.bootstrapToggle('off');

                //Add the change logic after it loads
                toggleControl.change(function() {
                    lastValue = $(this).prop('checked');
                    timeoutId = changeVariable(timeoutId, variableName, lastValue, onChange);               
                });  
            });
        }

        function showStatusFromBooleanVariable(control)
        {
            $.getJSON("/variable/get?name=" + control.attr("id"), function(result) {
                control.removeClass("status-" + (result.value ? "off": "on"))
                control.addClass("status-" + (result.value ? "on": "off"));
           }); 
        }

        function loadUiData()
        {            
            var heaterEnabled = $('#heat-enabled-toggle');
            var slideToggle = $('#slide-toggle');
            var freezePreventionEnabled = $('#freeze-prevention-enabled');
            var freezePreventionOn = $("#freeze-prevention-on");
            var solarHeaterOn = $("#solar-heat-on");

            freezePreventionEnabled.bootstrapToggle({
                on: 'Enabled',
                off: 'Disabled'
            });

            heaterEnabled.bootstrapToggle({
                on: 'Enabled',
                off: 'Disabled'
            });            

            slideToggle.bootstrapToggle({
                on: 'Having Fun',
                off: 'Off'
            });

            $.getJSON("/valve/get",function(result){
                var valves = $("#valves")
                valves.empty();

                $.each(result, function(i, item) {
                    console.log(JSON.stringify(item));
                    var container = $("<div>");
                    var toggle = $("<input type='checkbox' id='valve-"+item.apiName+"' data-apiName='"+item.apiName+"' data-style='slow'>");

                    
                    container.append(toggle);
                    container.append($("<span style='margin-left:5px;'>" + item.name + "</span>"));

                    toggle.bootstrapToggle({
                        on: 'On',
                        off: 'Off'
                    });
                    
                    if(item.isOn)
                        toggle.bootstrapToggle('on');
                    else
                        toggle.bootstrapToggle('off');

                    valves.append(container);
                    var lastValue = null;
                    var timeoutId = null;
                    //Add the change logic after it loads
                    toggle.change(function() {
                        lastValue = $(this).prop('checked');

                        if(timeoutId != null)                    
                            clearTimeout(timeoutId);

                        timeoutId = setTimeout(function(){
                            $.ajax({
                                url: '/valve/' + (lastValue ? "on" : "off") + "?name=" + item.apiName,
                                success: function(){
                                    console.log("valve: " + lastValue);
                                }
                            });
                        },5000)                                         
                    });  

                    
                });
            });
            
            $.getJSON("/variable/get?name=" + heaterVariable, function(result) {
                var control = $("#heat-temperature");
                var timeoutId = null;
                var lastValue = 0.0;
                control.val(result.value);
                control.on("input", function(item){       
                    lastValue = parseFloat($(this).val());             
                    timeoutId = changeVariable(timeoutId, heaterVariable, lastValue, null);
                });
            });
            showStatusFromBooleanVariable(freezePreventionOn);
            showStatusFromBooleanVariable(solarHeaterOn);

            setToggleFromVariable(
                freezePreventionEnabled.attr("id"), 
                freezePreventionEnabled, 
                function(){
                    //Give the server enough time to react
                    setTimeout(function(){
                        showStatusFromBooleanVariable(freezePreventionOn);
                    },5000)
                });        

            setToggleFromVariable(
                heaterEnabledVariable, 
                heaterEnabled, 
                //If enabled or disabled update the status
                function(data){
                    //Give the server enough time to react
                    setTimeout(function(){
                        showStatusFromBooleanVariable(solarHeaterOn);
                    },5000)                    
            });
            setToggleFromVariable(slideVariable, slideToggle, null);


            $.getJSON("/light/descriptions", function(result) {
                var options = $("#scene");
                options.empty();
                //don't forget error handling!
                $.each(result, function(index) {
                    options.append($("<option />").val(index).text(this[1] + ' - ' + this[2]));
                });
            });

            $.getJSON("/pump/descriptions", function(result) {
                var pumps = $("#pumps");
                pumps.empty();

                //don't forget error handling!
                $.each(result, function(pumpIndex, pump) {
                    console.log("pump=" + pump.description)
                    pumps.append(("<div>"+pump.description+"</div>"))
                    
                    speedControl = $('<select name="speed" id="speed" style="width: 250px;" onchange="speedChange(this)"></select>');
                    pumps.append(speedControl)
                    
                    $.each(pump.speeds, function(speedIndex, speed){
                        speedControl.append($("<option id='pump_" + pump.index + "_" + speed.name + "' "+ (speed.isActive? "selected":"") +" />").text(speed.name));
                    });
                });
            });

            $.getJSON("/schedule/schedules", function(result) {
                var options = $("#schedule");
                options.empty();

                if(result.overrides.length > 0)
                {
                    options.append($("<span>Overrides:</span>"));
                    $.each(result.overrides, function(overrideIndex, override) {
                        options.append($("<span>" + override.displayName + "</span>"));
                    });                         
                }

                var container = $("<table class='table'>");
                    container.append("<tr><th></th><th>Start</th><th>End</th><th class='details'>Pumps</th><th class='details'>Valves</th></tr>");

                //don't forget error handling!
                $.each(result.schedules, function(scheduleIndex, schedule) {                         
                    var row = "<tr id='schedule-" + schedule.id + "'>";
                    format = "hh:mm p";
                    startTime = $.format.date(new Date(schedule.scheduleStart),format);
                    endTime = $.format.date(new Date(schedule.scheduleEnd),format);

                    row += "<th class='" + (schedule.isRunning? "status-on" : "") + "'>" + schedule.name + "</th>";
                    row += "<td>"+startTime + "</td><td>" + endTime + " (" + schedule.duration.toFixed(1) + "hrs)</td>";
                    
                    row += "<td>";
                    $.each(schedule.pumps, function(pumpIndex, pump){
                        row+="<div id='schdule-"+schedule.id+"-pump-" + pump.id + "'>" + pump.name + " (" + pump.speedName + ")</div>";
                    });
                    row += "</td>";

                    row += "<td>";
                    $.each(schedule.valves, function(valveIndex, valve){
                        row+= "<div id='schdule-"+schedule.id+"-valve-" + valve.id + "'>" + valve.name + "</div>";
                    });
                    row += "</td>";
                    row +="</tr>";

                    container.append(row);                    
                });

                options.append(container);
            });

            $.getJSON("/temperature/sensors", function(result) {
                var options = $("#temperature");
                options.empty();

                //don't forget error handling!
                $.each(result, function(tempIndex, temp) {
                    container = `
                        <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">%name%</h3>
                        </div>
                        <div class="panel-body">
                            <div>%temperature%</div>
                        </div>
                    </div>
                    `;
                    container = container.replace("%name%", temp.name)
                    container = container.replace("%temperature%", temp.temp.toFixed(2))
                    
                    options.append(container);
                });
            });
        }
        
        function speedChange(control)
        {
            $.ajax({
                    url: '/pump/on?pumpIndex=0&speed=' + $(control).val(),
                    success: function(){
                        alert('changed speed to ' + $(control).val());
                    }
            });
        }

        function sceneChange(){
            var selectedValue = $('#scene option').filter(":selected").val();

            if(selectedValue >= 0)
            {
                $.ajax({
                    url: '/light/change?sceneIndex=' + selectedValue,
                    success: function(){
                        alert('changed scene');
                    }
                    });
            }
        }

        function lightOff(){
            $.ajax({
                url: '/off',
                success: function(){
                    alert('turned off');
                }
                });
        }
    </script>
</html>