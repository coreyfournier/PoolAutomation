<!DOCTYPE html >
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    
   <head>
      <title>Pool Controls</title>
      <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/site.css">
    <link rel="stylesheet" href="/css/bootstrap-toggle.min.css">
    
   </head>
    <script src="/js/jquery-3.6.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap-toggle.min.js"></script>
    
	
   <body>
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Schedules</h3>
                    </div>
                    <div class="panel-body">
                        <div id="schedule"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-2" id="temperature"></div>

            <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">GloBrite Color Changer</h3>
                </div>
                <div class="panel-body">
                    <p>Choose A Scene</p>
                    <select name="scene" id="scene" style="width: 250px;"><option value="-1">-</option>></select>
                    <button onclick="sceneChange()">Change</button>
                    <br>
                    <br>
                    <button onclick="lightOff()">Off</button>
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pump</h3>
                </div>
                <div class="panel-body">
                    <select name="speed" id="speed" style="width: 250px;" onchange="speedChange(this)"></select>
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Slide</h3>
                </div>
                <div class="panel-body">
                    <input type="checkbox" id="slide-toggle" data-style="slow">
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Solar Heater</h3>
                </div>
                <div class="panel-body">
                    <input type="number" min="80" step=".5" max="92" class="form-control" id="heater-temperature">
                    <input type="checkbox" id="heater-enabled-toggle" data-style="slow">
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title status-on" id="freeze-prevention-on">Freeze prevention</h3>
                </div>
                <div class="panel-body">
                    <input type="checkbox" id="freeze-prevention-enabled" data-style="slow">
                </div>
            </div>
        </div>
    </div>
    
      <div id="footer">
         <hr>
      </div>
    </div>		
   </body>
	<script>
        var heaterVariable = "solar-heat-temperature";
        var slideVariable = "slide-enabled";
        var heaterEnabledVariable = "solar-heat-enabled";

        function changeVariable(timeoutId, variable, lastValue)
        {
            //Adding a delay so it doesn't over load the server if you are togging through the values.
            if(timeoutId != null)                    
                clearTimeout(timeoutId);            

            timeoutId = setTimeout(function(){
                console.log("Changing " + lastValue);
                if(timeoutId != null)                    
                    clearTimeout(timeoutId);

                $.ajax({
                    type:"POST",
                    dataType:"json",
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify({
                        "name" : variable,
                        "value": lastValue
                    }),
                    url: '/variable/change',
                    success: function(result){
                        console.log('Variable changed ' + JSON.stringify(result));
                    }
                });
                
            }, 5000);                    
            
            return timeoutId;
        }

        function setToggleFromVariable(variableName, toggleControl)
        {
            $.getJSON("/variable/get?name=" + variableName, function(result) {
                var lastValue = false;
                var timeoutId = null;

                if(result.value)
                    toggleControl.bootstrapToggle('on');
                else
                    toggleControl.bootstrapToggle('off');

                //Add the change logic after it loads
                toggleControl.change(function() {
                    lastValue = $(this).prop('checked');
                    timeoutId = changeVariable(timeoutId, variableName, lastValue);               
                });  
            });
        }

        $(document).ready(function(){
            
            var heaterEnabled = $('#heater-enabled-toggle');
            var slideToggle = $('#slide-toggle');
            var freezePreventionEnabled = $('#freeze-prevention-enabled');
            var freezePreventionOn = $("#freeze-prevention-on");

            freezePreventionEnabled.bootstrapToggle({
                on: 'Enabled',
                off: 'Disabled'
            });

            heaterEnabled.bootstrapToggle({
                on: 'Enabled',
                off: 'Disabled'
            });            

            slideToggle.bootstrapToggle({
                on: 'Having Fun',
                off: 'Off'
            });
            
            $.getJSON("/variable/get?name=" + heaterVariable, function(result) {
                var control = $("#heater-temperature");
                var timeoutId = null;
                var lastValue = 0.0;
                control.val(result.value);
                control.on("input", function(item){       
                    lastValue = parseFloat($(this).val());             
                    timeoutId = changeVariable(timeoutId, heaterVariable, lastValue);
                });
            });

            $.getJSON("/variable/get?name=" + freezePreventionOn.attr("id"), function(result) {
                freezePreventionOn.removeClass("status-" + (result.value ? "off": "on"))
                freezePreventionOn.addClass("status-" + (result.value ? "on": "off"));
           });

            setToggleFromVariable(freezePreventionEnabled.attr("id"), freezePreventionEnabled);            
            setToggleFromVariable(heaterEnabledVariable, heaterEnabled);
            setToggleFromVariable(slideVariable, slideToggle);


            $.getJSON("/light/descriptions", function(result) {
                var options = $("#scene");
                //don't forget error handling!
                $.each(result, function(index) {
                    options.append($("<option />").val(index).text(this[1] + ' - ' + this[2]));
                });
            });

            $.getJSON("/pump/descriptions", function(result) {
                var options = $("#speed");
                //don't forget error handling!
                $.each(result, function(pumpIndex, pump) {
                    console.log("pump=" + pump.description)
                    $.each(pump.speeds, function(speedIndex, speed){
                        options.append($("<option id='pump_" + pump.index + "_" + speed.name + "' "+ (speed.isActive? "selected":"") +" />").text(speed.name));
                    });
                });
            });

            $.getJSON("/schedule/schedules", function(result) {
                var options = $("#schedule");
                var container = $("<table class='table'>");
                    container.append("<tr><th></th><th class='time'>Start</th><th class='time'>End</th><th class='details'>Pumps</th><th class='details'>Valves</th></tr>");

                //don't forget error handling!
                $.each(result, function(scheduleIndex, schedule) {                         
                    var row = "<tr id='schedule-" + schedule.id + "'>";
                    
                    row += "<th>"+schedule.name + (schedule.isRunning? " - running" : "") + "</th>";
                    row += "<td>"+schedule.startTime + "</td><td>" + schedule.endTime + "</td>";
                    
                    row += "<td>";
                    $.each(schedule.pumps, function(pumpIndex, pump){
                        row+="<div id='schdule-"+schedule.id+"-pump-" + pump.id + "'>" + pump.name + " (" + pump.speedName + ")</div>";
                    });
                    row += "</td>";

                    row += "<td>";
                    $.each(schedule.valves, function(valveIndex, valve){
                        row+= "<div id='schdule-"+schedule.id+"-valve-" + valve.id + "'>" + valve.name + "</div>";
                    });
                    row += "</td>";
                    row +="</tr>";

                    container.append(row);                    
                });

                options.append(container);
            });

            $.getJSON("/temperature/sensors", function(result) {
                var options = $("#temperature");
                //don't forget error handling!
                $.each(result, function(tempIndex, temp) {
                    container = `
                        <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">%name%</h3>
                        </div>
                        <div class="panel-body">
                            <div>%temperature%</div>
                        </div>
                    </div>
                    `;
                    container = container.replace("%name%", temp.name)
                    container = container.replace("%temperature%", temp.temp)
                    
                    options.append(container);
                });
            });
        });
        
        function speedChange(control)
        {
            console.log($(control).val());
            $.ajax({
                    url: '/pump/on?pumpIndex=0&speed=' + $(control).val(),
                    success: function(){
                        alert('changed speed to ' + $(control).val());
                    }
            });
        }

        function sceneChange(){
            var selectedValue = $('#scene option').filter(":selected").val();

            if(selectedValue >= 0)
            {
                $.ajax({
                    url: '/light/change?sceneIndex=' + selectedValue,
                    success: function(){
                        alert('changed scene');
                    }
                    });
            }
        }

        function lightOff(){
            $.ajax({
                url: '/off',
                success: function(){
                    alert('turned off');
                }
                });
        }
    </script>
</html>